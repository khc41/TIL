## 📅 2025-03-15
### 📖 읽은 블로그: [일 3,000만 건의 네이버페이 주문 메시지를 처리하는 Kafka 시스템의 무중단 전환 사례](https://d2.naver.com/helloworld/9581727)
#### ✏️ 세 줄 요약 
- 기존 트랜잭셔널 아웃박스 패턴을 사용해 별도 배치 서비스에서 주문 메시지 발행했으나, 공용 kafka를 사용하면서 메시지 지연과 최신 데이터 제공 등의 문제가 있었다.
- 이를 해결하기 위해 주문 메시지 전용 kafka 및 CDC를 도입하려 했지만, 메시지 신뢰성 보장에 대해 문제가 발생했고, 검증용 메시지를 발행/소비하면서 기존 주문 메시지와 비교해 오류 사항들을 검출 및 수정했다.
- 운영중인 서비스에 영향을 주지 않기 위해 MirrorMaker로 기존 발행되던 메시지를 신규 브로커로 복사하고, 컨슈머 롤링 배포를 통해 중복 소비를 방지했다. 또한, 주문 API에 스위치를 추가해 동적으로 kafka 브로커를 변경할 수 있도록 설계해 문제를 해결했다.  
#### 💡 느낀 점
- 여러 팀이 공유하는 kafka를 전환하는 것이 단순한 작업이 아니라는 점을 다시금 느꼈고, 이를 안정적으로 수행하기 위해 고려해야 할 요소들이 많다는 점이 인상적이었다.
- 운영중인 서비스를 배포할 때, 단순히 시스템 점검을 이유로 중단하는 것이 아니라 사용자 경험을 해치지 않기 위해 무중단 배포를 위한 전략을 고민하고 적용하는 과정이 인상깊었다.
- 특히, 기존 kafka 브로커와 신규 kafka 브로커를 동시에 소비하면 중복 소비가 발생할 수 있어, 기존 Blue-Green 배포 전략을 그대로 적용하면 문제가 생길 수 있다는 점이 흥미로웠다. CI/CD 배포 방식에 따라 예상치 못한 문제가 발생할 수 있음을 깨달았다.
- 운영하고 있는 시스템의 작은 요소 하나까지도 어떤 방식으로 동작하는지, 각 방식의 장/단점은 무엇인지, 배포 및 운영 과정에서 어떤 리스크가 있는지에 대해 더 깊이 이해할 필요가 있다고 느꼈다.
