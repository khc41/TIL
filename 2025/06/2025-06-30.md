## 📅 2025-06-30
### 📚 읽은 개발 서적: [가상면접 사례로 배우는 대규모 시스템 설계 기초](https://product.kyobobook.co.kr/detail/S000001033116)
#### ✏️ 8장 - URL 단축기 설계
#### 1단계 - 문제 이해 및 설계 범위 확정
- 동작, 트래픽 규모, 단축 URL의 길이, 문자형식, 삭제나 갱신 여부 등을 고려해서 질문한다.
- **개략적 추정**
  - 쓰기 연산: 매일 1억 개의 단축 URL 생성
  - 초당 쓰기 연산: 1억 / 24 / 3600 = 1160
  - 읽기 연산: 읽기 연산과 쓰기 연산 비율은 10:1 이라고 하자. 그 경우 읽기 연산은 초당 11,600회 발생한다.
  - URL 단축 서비스를 10년간 운영하면 1억 * 365 * 10 = 3650억개의 레코드를 보관해야 한다.
  - 축약 전 URL의 평균 길이는 100자라고 가정한다.
  - 10년 동안 필요한 저장 용량은 3650억 * 100 바이트 = 36.5TB
#### 2단계 - 개략적 설계안 제시 및 동의 구하기
- **API 엔드포인트**
  - URL 단축용 엔드포인트
    - POST /api/v1/data/shorten
  - URL 리디렉션용 엔드포인트
    - GET /api/v1/shortUrl
- **URL 리디렉션**
  - 단축 URL을 받은 서버는 그 URL을 원래 URL로 바꿔서 301 응답의 Location 헤더에 넣어 변환한다.
  - 301은 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답이므로, 브라우저는 이 응답을 캐시해서 요청을 보낸다.
  - 302는 일시적으로 Location 헤더에 반환된 URL에 의해 처리되어야 한다는 응답이므로, 언제나 단축 URL 서버에 먼저 보내진다.
  - 서버 부하를 줄이기 위해선 301, 트래픽 분석이 중요할 때는 302를 쓰는 것이 좋다.
  - 구현에 해시 테이블을 사용하는 것이 가장 직관적이다.
- **URL 단축**
  - 해시함수
    - 입력 URL이 다른 값이면 해시 값도 달라야 한다.
    - 원래 값으로 복원돼야 한다.
#### 3단계 - 상세 설계
- **데이터 모델**
  - 해시 테이블은 메모리에 올려두므로 비싸고 유한해서 사용하기 힘들다.
  - 관계형 데이터 베이스에 순서쌍을 저장하는 것이 간단하다.
- **해시 함수**
  - 원래 URL을 단축 URL로 변환하는데 쓰인다. 단축 URL은 hashValue라고 지칭한다.
- **해시 값 길이**
  - hashValue는 [0-9, a-z, A-Z]의 62개 문자로 구성된다고 가정한다.
  - 추정치에 따르면 62^n >= 3650억인 n의 최솟값을 찾아야 한다. (n은 7)
- **해시 후 충돌 해소**
  - 해시 함수는 잘 알려진 CRC32, MD5, SHA-1 등을 사용할 수 있다.
  - 7자로 줄이려면 처음 7개 글자만 이용한 후 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙인다.
  - 한번 이상 데이터베이스에 질의해야 하므로 블룸 필터를 사용하면 성능을 높일 수 있다.
- **base-62 변환**
  - hashValue에 사용할 수 있는 문자의 개수가 62개이기 때문에 62진법의 수로 변환한다.
  - 유일성 보장 ID 생성기가 필요하고 ID 값이 커지면 같이 길어진다.
  - 보안상 문제가 될 소지가 있다.
- **URL 단축기 상세 설계**
  - 62진법 변환 기법 사용
    - 입력된 URL이 데이터베이스에 있는지 검사한다.
    - 있으면 반환, 없으면 유일한 ID를 생성한다.
    - 62진법 변환을 적용해 ID를 단축 URL로 만든다.
    - ID, 단축 URL, 원래 URL로 새 데이터베이스 레코드를 만든 후 반환한다.
- **URL 리디렉션 상세 설계**
  - 쓰기보다 읽기를 더 자주해서 단축 URL, 원래 URL 쌍을 캐시에 저장해 성능을 높인다.
#### 4단계 - 마무리
- 시간이 남는다면 아래의 항목들에 대해 고려해볼 수 있다.
  - 처리율 제한 장치(rate limiter)
  - 웹 서버의 규모 확장
  - 데이터베이스의 규모 확장
  - 데이터 분석 솔루션
  - 가용성, 데이터 일관성, 안정성
#### 💡 느낀 점
- URL 단축기를 설계하는 방법을 보면서 항상 원리가 궁금했었는데 간단하게 설계할 수 있다는 사실을 알게 됐다.
- 특히, 쓰기 요청보다 읽기 요청이 많다는 점을 고려해 캐시를 사용한다는 점이 인상 깊었다.
- 62진법 변환 등의 방법을 사용해 단축 URL을 생성하는 방법도 흥미로웠다.
- 301과 302 응답의 차이점을 배웠고, 각각의 상황에 맞게 사용하는 것이 중요하다는 것을 알게 됐다.