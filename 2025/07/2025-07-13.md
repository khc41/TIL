## 📅 2025-07-13
### 📚 읽은 개발 서적: [가상면접 사례로 배우는 대규모 시스템 설계 기초](https://product.kyobobook.co.kr/detail/S000001033116)
#### ✏️ 11장 - 뉴스 피드 시스템 설계
#### 1단계 - 문제 이해 및 설계 범위 확정
- 웹 / 앱 구분, 중요한 기능, 스토리 순서, 최대 친구 수, 트래픽 규모, 스토리가 지원하는 파일 형식(이미지, 비디오 등)을 논의해 요구사항을 확정한다.
#### 2단계 - 개략적 설계안 제시 및 동의 구하기
- **뉴스 피드 API**
  - 피드 발행 API
    - 새 스토리를 포스팅하는 API
    - POST /v1/me/feed
  - 피드 읽기 API
    - 뉴스 피드를 가져오는 API
    - GET /v1/me/feed
- **피드 발행**
  - 사용자: 앱이나 브라우저에서 새 포스팅을 올리는 주체
  - 로드밸런서: 트래픽 분산
  - 웹 서버: HTTP 요청을 내부 서비스로 중계
  - 포스팅 저장 서비스: 새 포스팅을 데이터베이스와 캐시에 저장
  - 포스팅 전송: 새 포스팅을 친구의 뉴스 피드에 푸시, 캐시 사용
  - 알림 서비스: 새 포스팅이 올라왔음을 알리거나 푸시 전송
- **뉴스 피드 생성**
  - 사용자: 뉴스 피드를 읽는 주체
  - 로드 밸런서: 트래픽 분산
  - 웹 서버: 트래픽을 뉴스 피드 서비스로 전송
  - 뉴스 피드 서비스: 캐시에서 뉴스 피드를 가져옴
  - 뉴스 피드 캐시: 뉴스 피드를 렌더링할 때 필요한 피드 ID 보관
#### 3단계 - 상세 설계
- **피드 발행 흐름 상세 설계**
  - 웹 서버
    - 클라이언트 통신, 인증, 처리율 제한 등의 기능 수행
  - 포스팅 전송(팬아웃) 서비스
    - 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달
      - 쓰기 시점에 팬아웃하는 모델: 포스팅 기록 시점에 뉴스 피드 갱신
        - 장점: 뉴스 피드 실시간 갱신, 뉴스 피드 읽기 시간 단축
        - 단점: 친구가 많은 사용자일 경우 핫키 문제 발생, 자주 이용하지 않는 사용자도 갱신 필요
      - 읽기 시점에 팬아웃하는 모델: 피드 읽기 시점에 뉴스 피드 갱신
        - 장점: 비활성화된 사용자나 거의 이용하지 않는 사용자의 경우 이 모델이 유리, 핫키 문제도 발생하지 않음
        - 단점: 뉴스 피드 읽는 데 많은 시간 소요
    - 결론
      - 대부분 사용자는 푸시 모델 사용
      - 친구나 팔로어가 아주 많은 사용자는 풀 모델 사용
      - 안정 해시를 통해 핫키 문제 완화
  - 팬아웃 서비스 동작 과정
    1. 그래프 데이터베이스에서 친구 ID 목록 조회
    2. 사용자 정보 캐시에서 친구들의 정보 조회, 사용자 설정에 따라 일부 친구는 제외 (업데이트 mute 등)
    3. 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 삽입
    4. 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내 뉴스 피드 데이터를 뉴스 피드 캐시에 삽입
       - 뉴스 피드 캐시는 <포스팅 ID, 사용자 ID>를 보관하는 매핑 테이블
       - 메모리를 적정 수준으로 유지하기 위해 캐시의 크기에 제한
- **피드 읽기 흐름 상세 설계**
  1. 사용자가 뉴스피드 읽기 요청
  2. 로드밸런서가 요청을 웹 서버로 전달
  3. 웹 서버는 뉴스 피드 서비스 호출
  4. 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록 조회
  5. 뉴스 피드에 표시할 사용자 이름, 사진, 포스팅 콘텐츠, 이미지 등을 사용자 캐시와 포스팅 캐시에서 조회
  6. 생성된 뉴스 피드를 JSON 형태로 클라이언트에 전송
- **캐시 구조**
  - 뉴스 피드: 뉴스 피드의 ID 보관
  - 콘텐츠: 포스팅 데이터 보관, 인기 콘텐츠는 따로 보관
  - 소셜 그래프: 사용자 간 관계 정보 보관
  - 행동: 포스팅에 대한 사용자 행위에 관한 정보 보관
  - 횟수: 좋아요, 응답, 팔로워, 팔로잉 등의 횟수 정보 보관
#### 4단계 - 마무리
- 회사마다 독특한 제약이나 요구조건이 있기 때문에 정답은 없다.
- 설계를 진행하고 기술을 선택할 때는 그 배경에 어떤 트레이드 오프가 있었는지 잘 이해하고 설명할 수 있어야 한다.
- 데이터베이스 규모 확장
  - 수직적 vs 수평적
  - SQL vs NoSQL
  - 주-부 다중화
  - 복제본(replica)에 대한 읽기 연산
  - 일관성 모델
  - 데이터베이스 샤딩
- 논의해보기 좋은 주제
  - 웹 계층 무상태로 운영
  - 가능한 많은 데이터 캐시 방법
  - 여러 데이터 센터 지원할 방법
  - 메시지 큐를 사용해 컴포넌트 결합도 낮추기
  - 핵심 메트릭에 대한 모니터링
#### 💡 느낀 점
- 처음에 읽기 전에 어떤 부분에 주안점을 두고 설계해야하는지 혼자 생각해봤다. 최신 뉴스피드는 캐시에 보관하고 오래된 뉴스피드는 데이터베이스에 보관하는 구조 정도로 생각했었다.
- 뉴스피드를 발행할 때 메시지 큐를 사용해 다른 사람의 뉴스피드에 푸시하는 구조를 생각했었는데, 읽기/쓰기 시점에 따른 팬아웃 모델이 달랐고 각각의 장단점에 대해 배웠다.
- 여기에 더불어 핫키 문제도 고려해야하고 안정 해시나 별도의 캐시 보관, 읽기 팬아웃으로 적용하는 방법을 배웠다.
