## 📅 2025-11-04
### 📖 읽은 블로그: [Redis New Connection 증가 이슈 돌아보기](https://techblog.woowahan.com/23121/)
#### ✏️ 요약
- 레디스 커넥션을 맺는 횟수가 피크시간보다 자정시간에 더 많이 증가하는 이슈가 발생했다.
- 확인해보니 RedisTemplate의 executePipelined 메서드는 파이프라인 전용 새 커넥션을 생성하고 있었는데 커넥션 풀을 사용해서 문제가 되지 않았다.
- GenericObjectPool의 기본 동작이 LIFO 방식이라서 최근에 사용한 커넥션 풀 위주로 사용하는데, 커넥션 풀에 대해 별도 설정을 하지 않으면 IDLE 상태의 커넥션을 정리하지 않았다.
  - 하지만, IDLE 상태의 커넥션을 정리하지 않으면 Elasticache에서 timeout 옵션에 지정된 시간 이후에 커넥션을 강제로 제거했다.
  - 로그를 확인해보니 lettuce의 ConnectionWatchDog 클래스에서 커넥션이 끊어지면 새로운 커넥션을 생성하고 있었다. 즉, 제거된 커넥션에 대해 계속 재연결을 시도했다.
- 커넥션 풀 전략을 FIFO로 변경해 모든 커넥션 풀이 골고루 사용되게끔 변경하고, IDLE 상태의 커넥션을 minEvictableIdleDuration, timeBetweenEvictionRuns 옵션으로 명시적으로 제거해서 문제를 해결했다.
#### 💡 느낀 점
- 내부 코드까지 깊게 파고들어 동작 원리를 파악하고 개선한 점이 인상 깊었다. 특히, 커넥션 풀의 재생성을 로그로 확인하고 원인을 분석해 명시적으로 제거해 새로운 커넥션 연결을 없애는 것이 인상깊었다.
- Elasticache의 파라미터에 있는 사소한 옵션이라도 운영 환경에서 사용하려면 무슨 역할을 하는지 꼼꼼히 살펴보는게 중요하다고 생각이 들었다.
- 처음에 조회 시점에 매번 새로운 커넥션을 만들고 있으면 커넥션 생성시간 동안 지연이 될 가능성을 언급했다. 근데 만약 IDLE 상태의 커넥션을 정리하면 결국엔 커넥션이 부족할 때 새로운 커넥션을 연결할텐데 결과적으로는 재연결은 막았지만, 기존에 우려했던 상황이 해결되지 않은건 아닌가하는 생각이 든다.
